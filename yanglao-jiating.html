<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>家庭财务规划计算器 - 智财未来</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
    <link href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css" rel="stylesheet">
    <style>
        @import url('https://fonts.googleapis.com/css2?family=Noto+Sans+SC:wght@300;400;500;700&display=swap');
        
        body {
            font-family: 'Noto Sans SC', sans-serif;
            background: linear-gradient(135deg, #0f172a 0%, #1e293b 100%);
            color: #e2e8f0;
        }
        
        .glass-panel {
            background: rgba(30, 41, 59, 0.7);
            backdrop-filter: blur(12px);
            border: 1px solid rgba(255, 255, 255, 0.1);
            box-shadow: 0 8px 32px 0 rgba(0, 0, 0, 0.37);
        }
        
        .input-field {
            background: rgba(15, 23, 42, 0.6);
            border: 1px solid rgba(148, 163, 184, 0.2);
            color: #f8fafc;
            transition: all 0.3s ease;
        }
        
        .input-field:focus {
            border-color: #3b82f6;
            box-shadow: 0 0 0 3px rgba(59, 130, 246, 0.1);
            outline: none;
        }
        
        .gradient-text {
            background: linear-gradient(135deg, #60a5fa 0%, #a78bfa 100%);
            -webkit-background-clip: text;
            -webkit-text-fill-color: transparent;
        }
        
        .progress-ring {
            transform: rotate(-90deg);
            transform-origin: 50% 50%;
        }
        
        .progress-ring-circle {
            transition: stroke-dashoffset 0.35s;
            transform-origin: 50% 50%;
        }
        
        .tab-active {
            background: linear-gradient(135deg, #3b82f6 0%, #8b5cf6 100%);
            color: white;
        }
        
        .slider-thumb::-webkit-slider-thumb {
            appearance: none;
            width: 20px;
            height: 20px;
            background: linear-gradient(135deg, #3b82f6 0%, #8b5cf6 100%);
            cursor: pointer;
            border-radius: 50%;
            box-shadow: 0 0 10px rgba(59, 130, 246, 0.5);
        }
        
        .animate-pulse-slow {
            animation: pulse 3s cubic-bezier(0.4, 0, 0.6, 1) infinite;
        }
        
        @keyframes slideIn {
            from { opacity: 0; transform: translateY(20px); }
            to { opacity: 1; transform: translateY(0); }
        }
        
        .slide-in {
            animation: slideIn 0.5s ease-out forwards;
        }
        
        .risk-low { color: #10b981; }
        .risk-medium { color: #f59e0b; }
        .risk-high { color: #ef4444; }
        
        .currency-input::before {
            content: '¥';
            position: absolute;
            left: 12px;
            color: #94a3b8;
        }
    </style>
</head>
<body class="min-h-screen p-4 md:p-8">

    <!-- Header -->
    <header class="max-w-7xl mx-auto mb-8 slide-in">
        <div class="flex flex-col md:flex-row justify-between items-center gap-4">
            <div class="text-center md:text-left">
                <h1 class="text-4xl font-bold gradient-text mb-2">
                    <i class="fas fa-chart-line mr-3"></i>智财未来
                </h1>
                <p class="text-slate-400">全方位家庭财务规划与退休教育金计算器</p>
            </div>
            <div class="flex gap-3">
                <button onclick="resetAll()" class="px-4 py-2 rounded-lg bg-slate-700 hover:bg-slate-600 transition-colors text-sm">
                    <i class="fas fa-redo mr-2"></i>重置数据
                </button>
                <button onclick="generateReport()" class="px-4 py-2 rounded-lg bg-gradient-to-r from-blue-500 to-purple-600 hover:from-blue-600 hover:to-purple-700 transition-all text-sm font-semibold shadow-lg">
                    <i class="fas fa-file-export mr-2"></i>生成报告
                </button>
            </div>
        </div>
    </header>

    <div class="max-w-7xl mx-auto grid grid-cols-1 lg:grid-cols-12 gap-6">
        
        <!-- Left Sidebar: Input Parameters -->
        <div class="lg:col-span-4 space-y-6 slide-in" style="animation-delay: 0.1s;">
            
            <!-- Basic Info -->
            <div class="glass-panel rounded-2xl p-6">
                <h2 class="text-xl font-semibold mb-4 flex items-center">
                    <i class="fas fa-user-circle mr-2 text-blue-400"></i>基础参数
                </h2>
                
                <div class="space-y-4">
                    <div class="grid grid-cols-2 gap-3">
                        <div>
                            <label class="block text-sm text-slate-400 mb-1">当前年龄</label>
                            <input type="number" id="currentAge" value="35" class="input-field w-full rounded-lg px-3 py-2 text-sm" onchange="calculateAll()">
                        </div>
                        <div>
                            <label class="block text-sm text-slate-400 mb-1">退休年龄</label>
                            <input type="number" id="retireAge" value="60" class="input-field w-full rounded-lg px-3 py-2 text-sm" onchange="calculateAll()">
                        </div>
                    </div>
                    
                    <div>
                        <label class="block text-sm text-slate-400 mb-1">预期寿命</label>
                        <input type="number" id="lifeExpectancy" value="85" class="input-field w-full rounded-lg px-3 py-2 text-sm" onchange="calculateAll()">
                    </div>
                    
                    <div class="border-t border-slate-700 pt-4 mt-4">
                        <h3 class="text-sm font-semibold text-purple-400 mb-3">子女教育规划</h3>
                        <div class="grid grid-cols-2 gap-3">
                            <div>
                                <label class="block text-xs text-slate-400 mb-1">子女当前年龄</label>
                                <input type="number" id="childCurrentAge" value="5" class="input-field w-full rounded-lg px-3 py-2 text-sm" onchange="calculateAll()">
                            </div>
                            <div>
                                <label class="block text-xs text-slate-400 mb-1">预计大学毕业年龄</label>
                                <input type="number" id="childGraduateAge" value="22" class="input-field w-full rounded-lg px-3 py-2 text-sm" onchange="calculateAll()">
                            </div>
                        </div>
                    </div>
                </div>
            </div>

            <!-- Income & Expenses -->
            <div class="glass-panel rounded-2xl p-6">
                <h2 class="text-xl font-semibold mb-4 flex items-center">
                    <i class="fas fa-wallet mr-2 text-green-400"></i>收支状况
                </h2>
                
                <div class="space-y-4">
                    <div>
                        <label class="block text-sm text-slate-400 mb-1">当前年收入 (万元)</label>
                        <div class="relative">
                            <span class="absolute left-3 top-2 text-slate-500">¥</span>
                            <input type="number" id="annualIncome" value="30" step="0.1" class="input-field w-full rounded-lg pl-8 pr-3 py-2 text-sm" onchange="calculateAll()">
                        </div>
                    </div>
                    
                    <div>
                        <label class="block text-sm text-slate-400 mb-1">预期收入增长率 (%)</label>
                        <input type="range" id="incomeGrowth" min="0" max="15" value="3" class="w-full h-2 bg-slate-700 rounded-lg appearance-none cursor-pointer slider-thumb" oninput="updateSliderValue('incomeGrowth', 'incomeGrowthVal'); calculateAll()">
                        <div class="flex justify-between text-xs text-slate-500 mt-1">
                            <span>0%</span>
                            <span id="incomeGrowthVal" class="text-blue-400 font-semibold">3%</span>
                            <span>15%</span>
                        </div>
                    </div>
                    
                    <div>
                        <label class="block text-sm text-slate-400 mb-1">当前年支出 (万元)</label>
                        <div class="relative">
                            <span class="absolute left-3 top-2 text-slate-500">¥</span>
                            <input type="number" id="annualExpense" value="15" step="0.1" class="input-field w-full rounded-lg pl-8 pr-3 py-2 text-sm" onchange="calculateAll()">
                        </div>
                    </div>
                    
                    <div>
                        <label class="block text-sm text-slate-400 mb-1">退休后支出比例 (%)</label>
                        <input type="range" id="retireExpenseRatio" min="50" max="100" value="70" class="w-full h-2 bg-slate-700 rounded-lg appearance-none cursor-pointer slider-thumb" oninput="updateSliderValue('retireExpenseRatio', 'retireExpenseVal'); calculateAll()">
                        <div class="flex justify-between text-xs text-slate-500 mt-1">
                            <span>50%</span>
                            <span id="retireExpenseVal" class="text-blue-400 font-semibold">70%</span>
                            <span>100%</span>
                        </div>
                    </div>
                </div>
            </div>

            <!-- Social Insurance -->
            <div class="glass-panel rounded-2xl p-6">
                <h2 class="text-xl font-semibold mb-4 flex items-center">
                    <i class="fas fa-shield-alt mr-2 text-yellow-400"></i>社保与通胀
                </h2>
                
                <div class="space-y-4">
                    <div>
                        <label class="block text-sm text-slate-400 mb-1">社保缴费基数 (元/月)</label>
                        <input type="number" id="socialBase" value="10000" class="input-field w-full rounded-lg px-3 py-2 text-sm" onchange="calculateAll()">
                    </div>
                    
                    <div>
                        <label class="block text-sm text-slate-400 mb-1">缴费年限</label>
                        <input type="number" id="socialYears" value="25" class="input-field w-full rounded-lg px-3 py-2 text-sm" onchange="calculateAll()">
                    </div>
                    
                    <div>
                        <label class="block text-sm text-slate-400 mb-1">预期通胀率 (%)</label>
                        <input type="range" id="inflationRate" min="1" max="8" value="3" step="0.1" class="w-full h-2 bg-slate-700 rounded-lg appearance-none cursor-pointer slider-thumb" oninput="updateSliderValue('inflationRate', 'inflationVal'); calculateAll()">
                        <div class="flex justify-between text-xs text-slate-500 mt-1">
                            <span>1%</span>
                            <span id="inflationVal" class="text-yellow-400 font-semibold">3%</span>
                            <span>8%</span>
                        </div>
                    </div>
                </div>
            </div>

            <!-- Investment Strategy -->
            <div class="glass-panel rounded-2xl p-6">
                <h2 class="text-xl font-semibold mb-4 flex items-center">
                    <i class="fas fa-chart-pie mr-2 text-purple-400"></i>投资组合
                </h2>
                
                <div class="space-y-4">
                    <div class="bg-slate-800/50 rounded-lg p-3 mb-3">
                        <div class="flex justify-between items-center mb-2">
                            <span class="text-sm text-slate-300">当前可投资资产</span>
                            <span class="text-sm font-semibold text-green-400">¥<span id="currentAssetDisplay">50</span>万</span>
                        </div>
                        <input type="range" id="currentAssets" min="0" max="500" value="50" class="w-full h-2 bg-slate-700 rounded-lg appearance-none cursor-pointer slider-thumb" oninput="updateSliderValue('currentAssets', 'currentAssetDisplay'); calculateAll()">
                    </div>

                    <div class="space-y-3">
                        <div class="flex items-center justify-between p-2 bg-slate-800/30 rounded-lg">
                            <div class="flex items-center gap-2">
                                <div class="w-3 h-3 rounded-full bg-green-500"></div>
                                <span class="text-sm">稳健型 (3-4%)</span>
                            </div>
                            <input type="number" id="allocationSafe" value="40" class="w-16 input-field rounded px-2 py-1 text-center text-sm" onchange="validateAllocation(); calculateAll()">%
                        </div>
                        
                        <div class="flex items-center justify-between p-2 bg-slate-800/30 rounded-lg">
                            <div class="flex items-center gap-2">
                                <div class="w-3 h-3 rounded-full bg-yellow-500"></div>
                                <span class="text-sm">平衡型 (5-7%)</span>
                            </div>
                            <input type="number" id="allocationBalanced" value="40" class="w-16 input-field rounded px-2 py-1 text-center text-sm" onchange="validateAllocation(); calculateAll()">%
                        </div>
                        
                        <div class="flex items-center justify-between p-2 bg-slate-800/30 rounded-lg">
                            <div class="flex items-center gap-2">
                                <div class="w-3 h-3 rounded-full bg-red-500"></div>
                                <span class="text-sm">进取型 (8-12%)</span>
                            </div>
                            <input type="number" id="allocationAggressive" value="20" class="w-16 input-field rounded px-2 py-1 text-center text-sm" onchange="validateAllocation(); calculateAll()">%
                        </div>
                    </div>
                    
                    <div class="text-xs text-slate-500 mt-2" id="allocationWarning"></div>
                    
                    <div>
                        <label class="block text-sm text-slate-400 mb-1">预期综合收益率 (%)</label>
                        <input type="number" id="expectedReturn" value="5.5" step="0.1" class="input-field w-full rounded-lg px-3 py-2 text-sm bg-slate-800/50" readonly>
                    </div>
                </div>
            </div>
        </div>

        <!-- Right Content: Dashboard & Results -->
        <div class="lg:col-span-8 space-y-6 slide-in" style="animation-delay: 0.2s;">
            
            <!-- Key Metrics Cards -->
            <div class="grid grid-cols-1 md:grid-cols-3 gap-4">
                <div class="glass-panel rounded-2xl p-6 relative overflow-hidden">
                    <div class="absolute top-0 right-0 w-24 h-24 bg-blue-500/10 rounded-full -mr-8 -mt-8"></div>
                    <h3 class="text-slate-400 text-sm mb-1">退休资金缺口</h3>
                    <div class="text-2xl font-bold text-white mb-1">¥<span id="pensionGap">0</span>万</div>
                    <div class="text-xs text-slate-500">需额外储备</div>
                    <div class="mt-3 h-2 bg-slate-700 rounded-full overflow-hidden">
                        <div id="pensionProgress" class="h-full bg-gradient-to-r from-blue-500 to-cyan-400 transition-all duration-1000" style="width: 0%"></div>
                    </div>
                </div>
                
                <div class="glass-panel rounded-2xl p-6 relative overflow-hidden">
                    <div class="absolute top-0 right-0 w-24 h-24 bg-purple-500/10 rounded-full -mr-8 -mt-8"></div>
                    <h3 class="text-slate-400 text-sm mb-1">教育金总需求</h3>
                    <div class="text-2xl font-bold text-white mb-1">¥<span id="educationTotal">0</span>万</div>
                    <div class="text-xs text-slate-500">至子女大学毕业</div>
                    <div class="mt-3 h-2 bg-slate-700 rounded-full overflow-hidden">
                        <div id="educationProgress" class="h-full bg-gradient-to-r from-purple-500 to-pink-400 transition-all duration-1000" style="width: 0%"></div>
                    </div>
                </div>
                
                <div class="glass-panel rounded-2xl p-6 relative overflow-hidden">
                    <div class="absolute top-0 right-0 w-24 h-24 bg-green-500/10 rounded-full -mr-8 -mt-8"></div>
                    <h3 class="text-slate-400 text-sm mb-1">预计养老金替代率</h3>
                    <div class="text-2xl font-bold text-white mb-1"><span id="replacementRate">0</span>%</div>
                    <div class="text-xs text-slate-500">社保+个人储备</div>
                    <div class="mt-3 flex items-center gap-2">
                        <span class="text-xs px-2 py-1 rounded bg-green-500/20 text-green-400" id="pensionStatus">计算中...</span>
                    </div>
                </div>
            </div>

            <!-- Charts Section -->
            <div class="grid grid-cols-1 md:grid-cols-2 gap-6">
                <!-- Accumulation Curve -->
                <div class="glass-panel rounded-2xl p-6">
                    <h3 class="text-lg font-semibold mb-4 flex items-center justify-between">
                        <span><i class="fas fa-chart-area mr-2 text-blue-400"></i>资金积累曲线</span>
                        <span class="text-xs text-slate-500">单位：万元</span>
                    </h3>
                    <canvas id="accumulationChart" height="250"></canvas>
                </div>
                
                <!-- Asset Allocation -->
                <div class="glass-panel rounded-2xl p-6">
                    <h3 class="text-lg font-semibold mb-4 flex items-center justify-between">
                        <span><i class="fas fa-pie-chart mr-2 text-purple-400"></i>支出结构分析</span>
                        <span class="text-xs text-slate-500">年度占比</span>
                    </h3>
                    <canvas id="expenseChart" height="250"></canvas>
                </div>
            </div>

            <!-- Detailed Analysis Tabs -->
            <div class="glass-panel rounded-2xl p-6">
                <div class="flex flex-wrap gap-2 mb-6 border-b border-slate-700 pb-4">
                    <button onclick="switchTab('pension')" id="tab-pension" class="tab-btn px-4 py-2 rounded-lg text-sm font-medium transition-all tab-active">
                        <i class="fas fa-umbrella-beach mr-2"></i>养老金测算
                    </button>
                    <button onclick="switchTab('education')" id="tab-education" class="tab-btn px-4 py-2 rounded-lg text-sm font-medium transition-all hover:bg-slate-700 text-slate-300">
                        <i class="fas fa-graduation-cap mr-2"></i>教育金规划
                    </button>
                    <button onclick="switchTab('sensitivity')" id="tab-sensitivity" class="tab-btn px-4 py-2 rounded-lg text-sm font-medium transition-all hover:bg-slate-700 text-slate-300">
                        <i class="fas fa-sliders-h mr-2"></i>敏感性分析
                    </button>
                    <button onclick="switchTab('timeline')" id="tab-timeline" class="tab-btn px-4 py-2 rounded-lg text-sm font-medium transition-all hover:bg-slate-700 text-slate-300">
                        <i class="fas fa-stream mr-2"></i>时间轴规划
                    </button>
                </div>

                <!-- Pension Tab Content -->
                <div id="content-pension" class="tab-content">
                    <div class="grid grid-cols-1 md:grid-cols-2 gap-6">
                        <div>
                            <h4 class="text-lg font-semibold mb-4 text-blue-400">社保养老金测算 (2026政策)</h4>
                            <div class="space-y-3 text-sm">
                                <div class="flex justify-between p-3 bg-slate-800/50 rounded-lg">
                                    <span class="text-slate-400">基础养老金</span>
                                    <span class="font-semibold">¥<span id="basicPension">0</span>/月</span>
                                </div>
                                <div class="flex justify-between p-3 bg-slate-800/50 rounded-lg">
                                    <span class="text-slate-400">个人账户养老金</span>
                                    <span class="font-semibold">¥<span id="personalPension">0</span>/月</span>
                                </div>
                                <div class="flex justify-between p-3 bg-blue-500/20 rounded-lg border border-blue-500/30">
                                    <span class="text-blue-300">社保养老金合计</span>
                                    <span class="font-bold text-blue-400">¥<span id="totalSocialPension">0</span>/月</span>
                                </div>
                                <div class="flex justify-between p-3 bg-purple-500/20 rounded-lg border border-purple-500/30">
                                    <span class="text-purple-300">需个人补充储备</span>
                                    <span class="font-bold text-purple-400">¥<span id="personalReserve">0</span>万</span>
                                </div>
                            </div>
                        </div>
                        <div>
                            <h4 class="text-lg font-semibold mb-4 text-green-400">退休生活品质维持</h4>
                            <div class="space-y-4">
                                <div>
                                    <div class="flex justify-between text-sm mb-2">
                                        <span class="text-slate-400">退休时所需月支出</span>
                                        <span class="text-white">¥<span id="retireMonthlyExpense">0</span></span>
                                    </div>
                                    <div class="h-2 bg-slate-700 rounded-full overflow-hidden">
                                        <div class="h-full bg-gradient-to-r from-green-500 to-emerald-400" style="width: 75%"></div>
                                    </div>
                                </div>
                                <div>
                                    <div class="flex justify-between text-sm mb-2">
                                        <span class="text-slate-400">社保可覆盖比例</span>
                                        <span class="text-white" id="socialCoverage">0%</span>
                                    </div>
                                    <div class="h-2 bg-slate-700 rounded-full overflow-hidden">
                                        <div id="socialCoverageBar" class="h-full bg-gradient-to-r from-blue-500 to-cyan-400 transition-all" style="width: 0%"></div>
                                    </div>
                                </div>
                                <div class="p-4 bg-slate-800/50 rounded-lg mt-4">
                                    <p class="text-xs text-slate-400 leading-relaxed">
                                        <i class="fas fa-info-circle mr-1 text-blue-400"></i>
                                        基于现行社保政策，基础养老金 = (退休时上年度社平工资 + 本人指数化月平均缴费工资) ÷ 2 × 缴费年限 × 1%。假设社平工资年增长率为<span id="wageGrowthAssumption">5%</span>。
                                    </p>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>

                <!-- Education Tab Content -->
                <div id="content-education" class="tab-content hidden">
                    <div class="overflow-x-auto">
                        <table class="w-full text-sm text-left">
                            <thead class="text-xs text-slate-400 uppercase bg-slate-800/50">
                                <tr>
                                    <th class="px-4 py-3 rounded-l-lg">教育阶段</th>
                                    <th class="px-4 py-3">年龄段</th>
                                    <th class="px-4 py-3">年费用 (当前)</th>
                                    <th class="px-4 py-3">通胀调整后</th>
                                    <th class="px-4 py-3 rounded-r-lg">总需储备</th>
                                </tr>
                            </thead>
                            <tbody id="educationTableBody" class="divide-y divide-slate-700">
                                <!-- Dynamic content -->
                            </tbody>
                        </table>
                    </div>
                    <div class="mt-6 p-4 bg-gradient-to-r from-purple-500/10 to-blue-500/10 rounded-lg border border-purple-500/20">
                        <h5 class="font-semibold text-purple-300 mb-2"><i class="fas fa-lightbulb mr-2"></i>教育金储备建议</h5>
                        <p class="text-sm text-slate-300 leading-relaxed" id="educationAdvice">
                            根据计算，您需要为子女教育储备约 <span class="text-white font-bold">0万元</span>。
                            建议采用"稳健为主、适度进取"的投资策略，在前10年可配置60%稳健型+40%平衡型资产，
                            随着子女接近大学年龄，逐步降低风险资产比例。
                        </p>
                    </div>
                </div>

                <!-- Sensitivity Tab Content -->
                <div id="content-sensitivity" class="tab-content hidden">
                    <div class="mb-4">
                        <h4 class="text-lg font-semibold mb-2">关键参数影响分析</h4>
                        <p class="text-sm text-slate-400">观察投资收益率和通胀率变化对退休资金缺口的影响</p>
                    </div>
                    <canvas id="sensitivityChart" height="200"></canvas>
                    <div class="grid grid-cols-3 gap-4 mt-6 text-center">
                        <div class="p-3 bg-slate-800/50 rounded-lg">
                            <div class="text-xs text-slate-400 mb-1">乐观情景 (高回报)</div>
                            <div class="text-lg font-bold text-green-400">¥<span id="optimisticScenario">0</span>万</div>
                            <div class="text-xs text-slate-500">缺口/盈余</div>
                        </div>
                        <div class="p-3 bg-slate-800/50 rounded-lg border border-blue-500/30">
                            <div class="text-xs text-blue-400 mb-1">基准情景</div>
                            <div class="text-lg font-bold text-white">¥<span id="baseScenario">0</span>万</div>
                            <div class="text-xs text-slate-500">缺口/盈余</div>
                        </div>
                        <div class="p-3 bg-slate-800/50 rounded-lg">
                            <div class="text-xs text-slate-400 mb-1">悲观情景 (高通胀)</div>
                            <div class="text-lg font-bold text-red-400">¥<span id="pessimisticScenario">0</span>万</div>
                            <div class="text-xs text-slate-500">缺口/盈余</div>
                        </div>
                    </div>
                </div>

                <!-- Timeline Tab Content -->
                <div id="content-timeline" class="tab-content hidden">
                    <div class="relative">
                        <div class="absolute left-4 top-0 bottom-0 w-0.5 bg-gradient-to-b from-blue-500 to-purple-500"></div>
                        <div id="timelineContainer" class="space-y-6 pl-12">
                            <!-- Dynamic timeline items -->
                        </div>
                    </div>
                </div>
            </div>

            <!-- Action Plan -->
            <div class="glass-panel rounded-2xl p-6 border-l-4 border-yellow-500">
                <h3 class="text-lg font-semibold mb-4 flex items-center text-yellow-400">
                    <i class="fas fa-tasks mr-2"></i>智能理财建议
                </h3>
                <div id="actionPlan" class="grid grid-cols-1 md:grid-cols-2 gap-4 text-sm">
                    <!-- Dynamic content -->
                </div>
            </div>

        </div>
    </div>

    <script>
        // Global variables
        let accumulationChart, expenseChart, sensitivityChart;
        let calculationResults = {};

        // Initialize
        document.addEventListener('DOMContentLoaded', function() {
            initCharts();
            calculateAll();
        });

        function updateSliderValue(inputId, displayId) {
            const val = document.getElementById(inputId).value;
            document.getElementById(displayId).textContent = val;
        }

        function validateAllocation() {
            const safe = parseInt(document.getElementById('allocationSafe').value) || 0;
            const balanced = parseInt(document.getElementById('allocationBalanced').value) || 0;
            const aggressive = parseInt(document.getElementById('allocationAggressive').value) || 0;
            const total = safe + balanced + aggressive;
            
            const warningEl = document.getElementById('allocationWarning');
            if (total !== 100) {
                warningEl.textContent = `警告：当前配置总和为 ${total}%，请调整为100%`;
                warningEl.className = 'text-xs text-red-400 mt-2';
            } else {
                warningEl.textContent = '配置比例合理';
                warningEl.className = 'text-xs text-green-400 mt-2';
            }
            
            // Calculate weighted return
            const weightedReturn = (safe * 0.035 + balanced * 0.06 + aggressive * 0.10) / 100;
            document.getElementById('expectedReturn').value = weightedReturn.toFixed(2);
        }

        function switchTab(tabName) {
            // Hide all contents
            document.querySelectorAll('.tab-content').forEach(el => el.classList.add('hidden'));
            document.getElementById(`content-${tabName}`).classList.remove('hidden');
            
            // Update buttons
            document.querySelectorAll('.tab-btn').forEach(btn => {
                btn.classList.remove('tab-active');
                btn.classList.add('text-slate-300', 'hover:bg-slate-700');
            });
            document.getElementById(`tab-${tabName}`).classList.add('tab-active');
            document.getElementById(`tab-${tabName}`).classList.remove('text-slate-300', 'hover:bg-slate-700');
            
            if (tabName === 'sensitivity') {
                updateSensitivityChart();
            }
        }

        function calculateAll() {
            validateAllocation();
            
            const params = getInputParams();
            const results = performCalculations(params);
            calculationResults = results;
            
            updateDashboard(results);
            updateCharts(results);
            updateEducationTable(results);
            updateTimeline(results);
            updateActionPlan(results);
        }

        function getInputParams() {
            return {
                currentAge: parseInt(document.getElementById('currentAge').value) || 35,
                retireAge: parseInt(document.getElementById('retireAge').value) || 60,
                lifeExpectancy: parseInt(document.getElementById('lifeExpectancy').value) || 85,
                childCurrentAge: parseInt(document.getElementById('childCurrentAge').value) || 5,
                childGraduateAge: parseInt(document.getElementById('childGraduateAge').value) || 22,
                annualIncome: parseFloat(document.getElementById('annualIncome').value) || 30,
                incomeGrowth: parseFloat(document.getElementById('incomeGrowth').value) || 3,
                annualExpense: parseFloat(document.getElementById('annualExpense').value) || 15,
                retireExpenseRatio: parseFloat(document.getElementById('retireExpenseRatio').value) || 70,
                socialBase: parseInt(document.getElementById('socialBase').value) || 10000,
                socialYears: parseInt(document.getElementById('socialYears').value) || 25,
                inflationRate: parseFloat(document.getElementById('inflationRate').value) || 3,
                currentAssets: parseFloat(document.getElementById('currentAssets').value) || 50,
                expectedReturn: parseFloat(document.getElementById('expectedReturn').value) || 5.5
            };
        }

        function performCalculations(p) {
            const yearsToRetire = p.retireAge - p.currentAge;
            const yearsInRetirement = p.lifeExpectancy - p.retireAge;
            
            // 1. Pension Calculation (2026 China Policy)
            // Assume current average social wage is 8000, growing at 5%
            const currentAvgWage = 8000;
            const wageGrowth = 0.05;
            const retireYear = 2026 + yearsToRetire;
            const avgWageAtRetire = currentAvgWage * Math.pow(1 + wageGrowth, yearsToRetire);
            const indexedWage = p.socialBase * Math.pow(1 + wageGrowth, yearsToRetire); // Simplified
            
            // Basic pension: (avg wage + indexed wage) / 2 * years * 1%
            const basicPensionMonthly = (avgWageAtRetire + indexedWage) / 2 * p.socialYears * 0.01;
            
            // Personal account: balance /计发月数 (139 for 60 years old)
            const personalBalance = p.socialBase * 0.08 * 12 * p.socialYears * 1.05; // Simplified with interest
            const personalPensionMonthly = personalBalance / 139;
            
            const totalSocialPensionMonthly = basicPensionMonthly + personalPensionMonthly;
            const totalSocialPensionAnnual = totalSocialPensionMonthly * 12 / 10000; // Convert to 万元
            
            // 2. Retirement Expense Needs
            const retireExpenseAnnual = p.annualExpense * (p.retireExpenseRatio / 100) * Math.pow(1 + p.inflationRate/100, yearsToRetire);
            const totalRetireNeeded = 0; // Will calculate PV of annuity
            
            // Calculate PV of retirement expenses (inflation adjusted)
            let retirePV = 0;
            for (let i = 0; i < yearsInRetirement; i++) {
                const expense = retireExpenseAnnual * Math.pow(1 + p.inflationRate/100, i);
                retirePV += expense / Math.pow(1 + p.expectedReturn/100, i);
            }
            
            const pensionGap = Math.max(0, retirePV - totalSocialPensionAnnual * yearsInRetirement);
            
            // 3. Education Cost Calculation
            const educationStages = [
                { name: '学前教育', startAge: 3, endAge: 6, annualCost: 3 },
                { name: '小学', startAge: 6, endAge: 12, annualCost: 2 },
                { name: '初中', startAge: 12, endAge: 15, annualCost: 2.5 },
                { name: '高中', startAge: 15, endAge: 18, annualCost: 3 },
                { name: '大学', startAge: 18, endAge: 22, annualCost: 6 }
            ];
            
            let educationTotal = 0;
            const educationDetails = [];
            
            educationStages.forEach(stage => {
                if (stage.startAge >= p.childCurrentAge) {
                    const years = stage.endAge - Math.max(stage.startAge, p.childCurrentAge);
                    const startYear = 2026 + (Math.max(stage.startAge, p.childCurrentAge) - p.childCurrentAge);
                    const inflationFactor = Math.pow(1 + p.inflationRate/100, startYear - 2026);
                    const adjustedAnnualCost = stage.annualCost * inflationFactor;
                    const stageTotal = adjustedAnnualCost * years;
                    
                    educationTotal += stageTotal;
                    educationDetails.push({
                        ...stage,
                        years: years,
                        currentCost: stage.annualCost,
                        adjustedCost: adjustedAnnualCost,
                        total: stageTotal,
                        startYear: startYear
                    });
                }
            });
            
            // 4. Accumulation Projection
            const accumulationData = [];
            const labels = [];
            let currentAsset = p.currentAssets;
            let totalPensionSaved = 0;
            
            for (let year = 0; year <= yearsToRetire; year++) {
                const age = p.currentAge + year;
                const income = p.annualIncome * Math.pow(1 + p.incomeGrowth/100, year);
                const expense = p.annualExpense * Math.pow(1 + p.inflationRate/100, year);
                const educationExpense = educationDetails.reduce((sum, edu) => {
                    if (age >= edu.startAge && age < edu.endAge) return sum + edu.adjustedCost;
                    return sum;
                }, 0);
                
                const surplus = income - expense - educationExpense;
                const investmentReturn = currentAsset * (p.expectedReturn/100);
                currentAsset = currentAsset + surplus + investmentReturn;
                
                accumulationData.push({
                    age: age,
                    asset: currentAsset,
                    income: income,
                    expense: expense + educationExpense,
                    surplus: surplus
                });
                labels.push(age);
            }
            
            // 5. Replacement Rate
            const finalIncome = p.annualIncome * Math.pow(1 + p.incomeGrowth/100, yearsToRetire);
            const replacementRate = (totalSocialPensionAnnual + (accumulationData[yearsToRetire]?.asset / yearsInRetirement * 0.04)) / finalIncome * 100;
            
            return {
                yearsToRetire,
                yearsInRetirement,
                basicPensionMonthly,
                personalPensionMonthly,
                totalSocialPensionMonthly,
                totalSocialPensionAnnual,
                retireExpenseAnnual,
                retirePV,
                pensionGap,
                educationTotal,
                educationDetails,
                accumulationData,
                labels,
                replacementRate,
                finalAsset: accumulationData[yearsToRetire]?.asset || 0
            };
        }

        function updateDashboard(results) {
            // Update main metrics
            document.getElementById('pensionGap').textContent = results.pensionGap.toFixed(1);
            document.getElementById('educationTotal').textContent = results.educationTotal.toFixed(1);
            document.getElementById('replacementRate').textContent = Math.min(results.replacementRate, 100).toFixed(1);
            
            // Update pension details
            document.getElementById('basicPension').textContent = results.basicPensionMonthly.toFixed(0);
            document.getElementById('personalPension').textContent = results.personalPensionMonthly.toFixed(0);
            document.getElementById('totalSocialPension').textContent = results.totalSocialPensionMonthly.toFixed(0);
            document.getElementById('personalReserve').textContent = results.pensionGap.toFixed(1);
            document.getElementById('retireMonthlyExpense').textContent = (results.retireExpenseAnnual / 12 * 10000).toFixed(0);
            
            const coverage = Math.min((results.totalSocialPensionAnnual * 10000) / (results.retireExpenseAnnual * 10000) * 100, 100);
            document.getElementById('socialCoverage').textContent = coverage.toFixed(1) + '%';
            document.getElementById('socialCoverageBar').style.width = coverage + '%';
            
            // Update progress bars
            const pensionProgress = Math.min((results.finalAsset / (results.pensionGap + results.finalAsset)) * 100, 100);
            document.getElementById('pensionProgress').style.width = pensionProgress + '%';
            
            // Status indicator
            const statusEl = document.getElementById('pensionStatus');
            if (results.replacementRate >= 70) {
                statusEl.textContent = '充足';
                statusEl.className = 'text-xs px-2 py-1 rounded bg-green-500/20 text-green-400';
            } else if (results.replacementRate >= 50) {
                statusEl.textContent = '基本';
                statusEl.className = 'text-xs px-2 py-1 rounded bg-yellow-500/20 text-yellow-400';
            } else {
                statusEl.textContent = '不足';
                statusEl.className = 'text-xs px-2 py-1 rounded bg-red-500/20 text-red-400';
            }
        }

        function updateEducationTable(results) {
            const tbody = document.getElementById('educationTableBody');
            tbody.innerHTML = '';
            
            results.educationDetails.forEach(edu => {
                const row = `
                    <tr class="hover:bg-slate-800/30 transition-colors">
                        <td class="px-4 py-3 font-medium text-white">${edu.name}</td>
                        <td class="px-4 py-3 text-slate-400">${edu.startAge}-${edu.endAge}岁</td>
                        <td class="px-4 py-3">¥${edu.currentCost}万</td>
                        <td class="px-4 py-3 text-yellow-400">¥${edu.adjustedCost.toFixed(1)}万</td>
                        <td class="px-4 py-3 font-semibold text-purple-400">¥${edu.total.toFixed(1)}万</td>
                    </tr>
                `;
                tbody.innerHTML += row;
            });
            
            document.getElementById('educationAdvice').innerHTML = 
                `根据计算，您需要为子女教育储备约 <span class="text-white font-bold">${results.educationTotal.toFixed(1)}万元</span>。
                 建议采用"稳健为主、适度进取"的投资策略，在前10年可配置60%稳健型+40%平衡型资产，
                 随着子女接近大学年龄，逐步降低风险资产比例至保守水平。`;
        }

        function updateTimeline(results) {
            const container = document.getElementById('timelineContainer');
            container.innerHTML = '';
            
            const milestones = [
                { age: results.educationDetails[0]?.startAge || 6, event: '学前教育开始', type: 'education' },
                { age: 18, event: '大学教育开始', type: 'education' },
                { age: parseInt(document.getElementById('retireAge').value), event: '退休', type: 'retirement' },
                { age: parseInt(document.getElementById('lifeExpectancy').value), event: '预期寿命', type: 'end' }
            ];
            
            milestones.forEach(m => {
                const colorClass = m.type === 'education' ? 'bg-purple-500' : m.type === 'retirement' ? 'bg-blue-500' : 'bg-slate-500';
                const icon = m.type === 'education' ? 'fa-graduation-cap' : m.type === 'retirement' ? 'fa-umbrella-beach' : 'fa-hourglass-end';
                
                const item = `
                    <div class="relative">
                        <div class="absolute -left-[38px] w-4 h-4 rounded-full ${colorClass} border-4 border-slate-900"></div>
                        <div class="bg-slate-800/50 rounded-lg p-4 border border-slate-700">
                            <div class="flex justify-between items-start mb-2">
                                <h5 class="font-semibold text-white flex items-center">
                                    <i class="fas ${icon} mr-2 ${colorClass.replace('bg-', 'text-')}"></i>
                                    ${m.event}
                                </h5>
                                <span class="text-xs px-2 py-1 rounded bg-slate-700 text-slate-300">${m.age}岁</span>
                            </div>
                            <p class="text-xs text-slate-400">
                                ${getMilestoneDescription(m, results)}
                            </p>
                        </div>
                    </div>
                `;
                container.innerHTML += item;
            });
        }

        function getMilestoneDescription(milestone, results) {
            if (milestone.type === 'education') {
                const edu = results.educationDetails.find(e => e.startAge === milestone.age);
                return edu ? `预计需要资金：¥${edu.total.toFixed(1)}万元，年均¥${edu.adjustedCost.toFixed(1)}万元` : '教育阶段开始';
            } else if (milestone.type === 'retirement') {
                return `预计养老金缺口：¥${results.pensionGap.toFixed(1)}万元，建议提前5年调整投资组合为保守型`;
            }
            return '';
        }

        function updateActionPlan(results) {
            const container = document.getElementById('actionPlan');
            const p = getInputParams();
            const monthlySave = (results.pensionGap + results.educationTotal) / (p.retireAge - p.currentAge) / 12;
            
            const suggestions = [];
            
            if (results.replacementRate < 60) {
                suggestions.push({
                    icon: 'fa-exclamation-triangle',
                    color: 'text-red-400',
                    title: '养老金替代率偏低',
                    desc: `当前方案替代率为${results.replacementRate.toFixed(1)}%，建议增加商业养老保险或提高投资收益率目标。`
                });
            }
            
            if (monthlySave > p.annualIncome * 0.3) {
                suggestions.push({
                    icon: 'fa-piggy-bank',
                    color: 'text-yellow-400',
                    title: '储蓄压力较大',
                    desc: `建议每月储蓄¥${(monthlySave * 10000).toFixed(0)}元，占收入${(monthlySave * 12 / p.annualIncome * 100).toFixed(1)}%，可考虑延长工作年限或降低退休后期望。`
                });
            }
            
            if (p.expectedReturn < 4) {
                suggestions.push({
                    icon: 'fa-chart-line',
                    color: 'text-green-400',
                    title: '提升投资效率',
                    desc: '当前预期收益率偏低，建议适当增加权益类资产配置，或咨询专业理财顾问优化投资组合。'
                });
            }
            
            if (results.educationTotal > p.annualIncome * 5) {
                suggestions.push({
                    icon: 'fa-graduation-cap',
                    color: 'text-purple-400',
                    title: '教育金储备提醒',
                    desc: '教育金需求较高，建议开设专门的教育金账户，采用定投方式分散时间风险。'
                });
            }
            
            if (suggestions.length === 0) {
                suggestions.push({
                    icon: 'fa-check-circle',
                    color: 'text-green-400',
                    title: '财务状况良好',
                    desc: '您的财务规划较为稳健，建议定期（每年）回顾并调整计划，确保目标达成。'
                });
            }
            
            container.innerHTML = suggestions.map(s => `
                <div class="flex items-start gap-3 p-3 bg-slate-800/30 rounded-lg">
                    <i class="fas ${s.icon} ${s.color} mt-1"></i>
                    <div>
                        <h5 class="font-medium text-white text-sm mb-1">${s.title}</h5>
                        <p class="text-xs text-slate-400 leading-relaxed">${s.desc}</p>
                    </div>
                </div>
            `).join('');
        }

        function initCharts() {
            // Accumulation Chart
            const ctx1 = document.getElementById('accumulationChart').getContext('2d');
            accumulationChart = new Chart(ctx1, {
                type: 'line',
                data: {
                    labels: [],
                    datasets: [{
                        label: '总资产积累',
                        data: [],
                        borderColor: '#3b82f6',
                        backgroundColor: 'rgba(59, 130, 246, 0.1)',
                        fill: true,
                        tension: 0.4
                    }, {
                        label: '年收入',
                        data: [],
                        borderColor: '#10b981',
                        borderDash: [5, 5],
                        tension: 0.4
                    }]
                },
                options: {
                    responsive: true,
                    maintainAspectRatio: false,
                    plugins: {
                        legend: { labels: { color: '#94a3b8' } }
                    },
                    scales: {
                        y: {
                            ticks: { color: '#64748b' },
                            grid: { color: 'rgba(148, 163, 184, 0.1)' }
                        },
                        x: {
                            ticks: { color: '#64748b' },
                            grid: { display: false }
                        }
                    }
                }
            });
            
            // Expense Chart
            const ctx2 = document.getElementById('expenseChart').getContext('2d');
            expenseChart = new Chart(ctx2, {
                type: 'doughnut',
                data: {
                    labels: ['生活支出', '教育支出', '储蓄/投资', '社保缴费', '其他'],
                    datasets: [{
                        data: [50, 20, 20, 10, 0],
                        backgroundColor: [
                            'rgba(59, 130, 246, 0.8)',
                            'rgba(139, 92, 246, 0.8)',
                            'rgba(16, 185, 129, 0.8)',
                            'rgba(245, 158, 11, 0.8)',
                            'rgba(239, 68, 68, 0.8)'
                        ],
                        borderWidth: 0
                    }]
                },
                options: {
                    responsive: true,
                    maintainAspectRatio: false,
                    plugins: {
                        legend: { 
                            position: 'bottom',
                            labels: { color: '#94a3b8', padding: 20 }
                        }
                    }
                }
            });
            
            // Sensitivity Chart
            const ctx3 = document.getElementById('sensitivityChart').getContext('2d');
            sensitivityChart = new Chart(ctx3, {
                type: 'bar',
                data: {
                    labels: ['低通胀(2%)', '基准(3%)', '高通胀(5%)'],
                    datasets: [{
                        label: '资金缺口',
                        data: [0, 0, 0],
                        backgroundColor: [
                            'rgba(16, 185, 129, 0.8)',
                            'rgba(59, 130, 246, 0.8)',
                            'rgba(239, 68, 68, 0.8)'
                        ]
                    }]
                },
                options: {
                    responsive: true,
                    maintainAspectRatio: false,
                    plugins: {
                        legend: { display: false }
                    },
                    scales: {
                        y: {
                            ticks: { color: '#64748b' },
                            grid: { color: 'rgba(148, 163, 184, 0.1)' }
                        },
                        x: {
                            ticks: { color: '#64748b' }
                        }
                    }
                }
            });
        }

        function updateCharts(results) {
            // Update accumulation chart
            accumulationChart.data.labels = results.labels;
            accumulationChart.data.datasets[0].data = results.accumulationData.map(d => d.asset);
            accumulationChart.data.datasets[1].data = results.accumulationData.map(d => d.income);
            accumulationChart.update();
            
            // Update expense chart
            const p = getInputParams();
            const expenseData = [
                p.annualExpense * 0.6, // Living
                results.educationTotal / (p.retireAge - p.currentAge), // Education annual
                p.annualIncome - p.annualExpense - (results.educationTotal / (p.retireAge - p.currentAge)), // Savings
                p.socialBase * 0.28 * 12 / 10000, // Social insurance
                p.annualExpense * 0.4 // Other
            ];
            expenseChart.data.datasets[0].data = expenseData.map(e => Math.max(0, e));
            expenseChart.update();
        }

        function updateSensitivityChart() {
            const p = getInputParams();
            const scenarios = [0.02, 0.03, 0.05]; // Inflation rates
            const gaps = [];
            
            scenarios.forEach(inflation => {
                const tempParams = {...p, inflationRate: inflation * 100};
                const tempResults = performCalculations(tempParams);
                gaps.push(tempResults.pensionGap);
            });
            
            sensitivityChart.data.datasets[0].data = gaps;
            sensitivityChart.update();
            
            document.getElementById('optimisticScenario').textContent = gaps[0].toFixed(1);
            document.getElementById('baseScenario').textContent = gaps[1].toFixed(1);
            document.getElementById('pessimisticScenario').textContent = gaps[2].toFixed(1);
        }

        function resetAll() {
            if (confirm('确定要重置所有数据吗？')) {
                document.getElementById('currentAge').value = 35;
                document.getElementById('retireAge').value = 60;
                document.getElementById('lifeExpectancy').value = 85;
                document.getElementById('childCurrentAge').value = 5;
                document.getElementById('childGraduateAge').value = 22;
                document.getElementById('annualIncome').value = 30;
                document.getElementById('annualExpense').value = 15;
                document.getElementById('socialBase').value = 10000;
                document.getElementById('socialYears').value = 25;
                document.getElementById('currentAssets').value = 50;
                
                // Reset sliders
                document.getElementById('incomeGrowth').value = 3;
                document.getElementById('retireExpenseRatio').value = 70;
                document.getElementById('inflationRate').value = 3;
                
                updateSliderValue('incomeGrowth', 'incomeGrowthVal');
                updateSliderValue('retireExpenseRatio', 'retireExpenseVal');
                updateSliderValue('inflationRate', 'inflationVal');
                updateSliderValue('currentAssets', 'currentAssetDisplay');
                
                document.getElementById('allocationSafe').value = 40;
                document.getElementById('allocationBalanced').value = 40;
                document.getElementById('allocationAggressive').value = 20;
                
                calculateAll();
            }
        }

        function generateReport() {
            alert('报告生成功能：在实际应用中，这里将生成PDF格式的详细财务规划报告，包含所有计算细节、图表和建议。');
        }
    </script>
</body>
</html>